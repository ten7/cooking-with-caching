<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<title>reveal.js</title>

		<link rel="stylesheet" href="dist/reset.css">
		<link rel="stylesheet" href="dist/reveal.css">
		<link rel="stylesheet" href="lib/css/sous-vide.css">

		<!-- Theme used for syntax highlighted code -->
		<link rel="stylesheet" href="plugin/highlight/monokai.css">
	</head>
	<body>
		<div class="reveal">
			<div class="slides">
				<section data-background-transition="none" data-background="img/PXL_20230713_163656163.jpg" data-background-size="">
					<h1>Cooking with Caching</h1>
					<p>&nbsp;</p>
					<p>Drupal code served fast!</p>
					<small><br/>use &larr;&uarr;&darr;&rarr; or &lt;space&gt;</small>
				</section>

				<section>
					<h2>Intro</h2>
					<p class="fragment">Some text</p>
				</section>

				<section>
					<h2>Content Warnings (CWs)</h2>
					<p class="fragment">Food, <span class="fragment">cooking,</span> <span class="fragment">and puns.</span></p>
				</section>

				<section>
					<h2>What the problem is</h2>
					<p class="fragment">Some text</p>
				</section>

				<section>
					<h2>What is cached?</h2>
					<p class="fragment">Some text</p>
				</section>

				<section>
					<section>
						<h1>Snacks</h1>
						<h2>Tiny morsels of caching</h2>
					</section>

					<section>
						<h2>Cache within the same request</h2>
						<p class="fragment">Small speedups</p>
						<p class="fragment">Encourage use of <code>$myClass->myMethod()</code></p>
					</section>

					<section>
						<h2>Static vars</h2>
						<p class="fragment">Persist for their <em>scope</em></p>
						<p class="fragment">Method, Function</p>
						<p class="fragment">Different from static class <em>properties</em>!</p>
					</section>

					<section>
						<pre><code>
function myFunction() {
	static $myVar = NULL;

	if (empty($myVar)) {
		// Generate the value here.
	}

	return $myVar;
}
						</code></pre>
					</section>

					<section>
						<h2>Static vars with reset</h2>
						<p class="fragment">Bypass cache when appropriate</p>
						<p class="fragment">Allow regeneration <ins>within the same request</ins></p>
					</section>

					<section>
						<pre><code>
function myFunction(bool $reset = FALSE) {
	static $myVar = NULL;

	if (empty($myVar) || $reset) {
		// Generate the value here.
	}

	return $myVar;
}
						</code></pre>
					</section>

					<section>
						<h2>Sharing static vars</h2>
						<p class="fragment">Share between methods, functions</p>
						<p class="fragment">Rarer, but useful!</p>
					</section>

					<section>
						<h2>drupal_static()</h2>
						<p class="fragment">Part of Drupal core</p>
						<p class="fragment">Assigns a globally unique name</p>
					</section>

					<section>
						<h2>When to use</h2>
						<p class="fragment">Function, method called <em>a lot</em></p>
						<p class="fragment">Value <em>never</em> needs reset mid-request!</p>
					</section>

					<section>
						<pre><code>
function myMethod() {
	$cache = &drupal_static(__FUNCTION__, FALSE);

	if (empty($cache)) {
		// Generate the value here.
	}

	return $cache;
}
						</code></pre>
					</section>

					<section>
						<h2><code>__FUNCTION__</code></h2>
						<p class="fragment">Constant, part of PHP</p>
						<p class="fragment">Replaced with the current function name</p>
					</section>
					<section>
						<h2>Why?</h2>
						<p class="fragment">Function names must be globally unique!</p>
						<p class="fragment">Easier refactoring</p>
					</section>

					<section>
						<h2>What about a class?</h2>
						<p class="fragment">Method names not globally unique</p>
						<p class="fragment"><code>__FUNCTION__</code> won't work!</p>
					</section>

					<section>
						<pre><code>
class MyClass {
	public function myMethod() {
		$cache = &drupal_static(__METHOD__, FALSE);

		if (empty($cache)) {
			// Generate the value here.
		}

		return $cache;
	}
}
						</code></pre>
					</section>

					<section>
						<h2><code>__METHOD__</code></h2>
						<p class="fragment">Like <code>__FUNCTION__</code></p>
						<p class="fragment">but includes class, namespace</p>
					</section>

					<section>
						<h2>Parameterizing static vars</h2>
						<p class="fragment">Create different results</p>
						<p class="fragment">Generate on ask</p>
					</section>

					<section>
						<pre><code>
class MyClass {
	public function myMethod(string $myParam) {

		// Init the cache to an array, not just FALSE.
		$cache = &drupal_static(__METHOD__, []);

		if (empty($cache[$param])) {
			// Generate the value for $myParam here.
		}

		return $cache;
	}
}
						</code></pre>
					</section>

					<section>
						<h2>Use an array</h2>
						<p class="fragment">The parameter is the <code>$key</code></p>
						<p class="fragment">Generate only for the given value</p>
					</section>

					<section>
						<h2>Only useful for scalars!</h2>
						<p class="fragment">Mostly <code>string</code> and <code>int</code></p>
						<p class="fragment">Rarely <code>bool</code> and <code>float</code></p>
					</section>

					<section>
						<h2>Reference parameters</h2>
						<p class="fragment">Objects, arrays</p>
						<p class="fragment">Generate a unique cache key</p>
					</section>

					<section>
						<pre><code>
class MyClass {
	public function myMethod(NodeInterface $node) {
		// Get the node ID, it's unique enough here.
		$nid = $node->id();

		$cache = &drupal_static(__METHOD__, []);

		if (empty($cache[$nid])) {
			// Generate the value for the node with ID $nid.
		}

		return $cache;
	}
}
						</code></pre>
					</section>

					<section>
						<h2>Multiple parameters</h2>
						<p class="fragment">Same idea!</p>
						<p class="fragment">with a longer key and hashing</p>
					</section>

					<section>
						<pre><code>
class MyClass {
	public function myMethod(NodeInterface $node,
							             string $param1,
							             string $param2) {

		// Get unique value for each, make a string, hash it.
		$cid = md5(implode(':', [$node->id(), $param1, $param2]));

		$cache = &drupal_static(__METHOD__, []);

		if (empty($cache[$cid])) {
			// Generate the value the unique $cid.
		}

		return $cache;
	}
}
						</code></pre>
						<small class="fragment">(Scroll down.)</small>
					</section>

					<section>
						<h2>Takeaways</h2>
						<p class="fragment">Use <code>drupal_static()</code> more often</p>
						<p class="fragment">Easy, low risk</p>
					</section>
				</section>

				<section>
					<section>
						<h1>Lunch</h1>
						<p class="fragment">Beyond the request</p>
					</section>

					<section data-transition="none" data-background-transition="none" data-background="img/whatAboutRedis1.png" data-background-size="contain">
						<h2>Persistent caching</h2>
						<p class="fragment">Cache values to disk</p>
						<p class="fragment">Typically, to the database</p>
					</section>
					<section data-transition="none" data-background-transition="none" data-background="img/whatAboutRedis2.png" data-background-size="contain">
						<h2>Persistent caching</h2>
						<p class="">Cache values to disk</p>
						<p class="">Typically, to the database</p>
					</section>
					<section data-transition="none" data-background-transition="none" data-background="img/whatAboutRedis3.png" data-background-size="contain">
						<h2>Persistent caching</h2>
						<p class="">Cache values to disk</p>
						<p class="">Typically, to the database</p>
					</section>

					<section data-transition="none" data-background-transition="none" data-background="img/whatAboutRedis4.png" data-background-size="contain">
						<h2>You don't!</h2>
						<p class="fragment">Redis, Memcache modules provide drivers</p>
					</section>
					<section data-transition="none" data-background-transition="none" data-background="img/whatAboutRedis5.png" data-background-size="contain">
						<h2>You don't!</h2>
						<p class="">Redis, Memcache modules provide drivers</p>
					</section>

					<section>
						<h2>Cache API</h2>
						<p class="fragment"><code>Drupal::cache()</code></p>
					</section>

					<section>
						<pre><code>
// Get the cache backend.
$cache = \Drupal::cache();

// Save something to it.
$cache->set('my:cache:key', $myValue);

// Get something from it.
$value = $cache->get('a:different:key');
						</code></pre>
					</section>

					<section data-background="img/bins.png" data-background-size="contain">
						<h2>Bins</h2>
						<p class="fragment">Divides up caches</p>
						<p class="fragment">Helps avoid "key stomping"</p>
					</section>

					<section>
						<pre><code>
$cacheBin = \Drupal::cache('default');

// Different bin...
$cacheBin->set('my:cache:key', $myValue);

// ...same set() and get().
$value = $cacheBin->get('a:different:key');
						</code></pre>
					</section>

					<section>
						<h2>Common cache bins</h2>
						<ul>
							<li class="fragment"><code>default</code>, regularly accessed data</li>
							<li class="fragment"><code>data</code>, better when less accessed</li>
							<li class="fragment"><code>bootstrap</code>, <code>render</code>, <code>discovery</code>, used internally</li>
						</ul>
					</section>

					<section>
						<h2>Where's it end up?</h2>
						<p class="fragment">Typically, a bin-named database table</p>
						<p class="fragment">Different bins, different drivers</p>
					</section>

					<section data-transition="none" data-background-transition="none" data-background="img/butIWantMyOwn1.png" data-background-size="contain">
					</section>

					<section data-transition="none" data-background-transition="none" data-background="img/butIWantMyOwn2.png" data-background-size="contain">
					</section>

					<section data-background="img/aBinOfHerOwn.png" data-background-size="contain">
						<h2>Custom bins</h2>
						<p class="fragment">Defined as a service</p>
						<p class="fragment">No need to boilerplate a class!</p>
					</section>

					<section data-transition="none">
						<pre><code>
docroot/modules/custom/my_module
├── config/
├── my_module.info.yml
├── my_module.module
│
└── src/
						</code></pre>
					</section>

					<section data-transition="none">
						<pre><code>
docroot/modules/custom/my_module
├── config/
├── my_module.info.yml
├── my_module.module
├── my_module.services.yml  // add or edit this file
└── src/
						</code></pre>
					</section>

					<section>
						<pre><code>
services:
  cache.my_module:
    class: Drupal\Core\Cache\CacheBackendInterface
    tags:
      - { name: cache.bin }
    factory: ['@cache_factory', 'get']
    arguments: [my_module]
						</code></pre>
					</section>

					<section>
						<h2>That's it!</h2>
						<p class="fragment">No need to generate a class</p>
						<p class="fragment">Creates a new service</p>
					</section>

					<section>
						<pre><code>
$my_module_cache = \Drupal::cache('my_module');
						</code></pre>
						<p class="fragment">...or...</p>
						<pre class="fragment"><code>
$my_module_cache = \Drupal::service('cache.my_module');
						</code></pre>
					</section>

					<section>
						<h2>Cache injection</h2>
						<p class="fragment">Use on forms, plugins, controllers</p>
					</section>

					<section>
						<pre><code>class MyController extends ControllerBase {

	public static function create(ContainerInterface $container) {
    $myCache = $container->get('cache.my_module');

    return new static($myCache);
  }

	public __construct(CacheBackendInterface $cache) {
		$this->cache = $cache;
	}

	public doSomething() {
		$this->cache->get('my:cache:key');
	}
}</code></pre>
					</section>

					<section data-transition="none" data-background-transition="none" data-background="img/soAllIHaveToDo1.png" data-background-size="contain">
					</section>
					<section data-transition="none" data-background-transition="none" data-background="img/soAllIHaveToDo2.png" data-background-size="contain">
					</section>
					<section data-transition="none" data-background-transition="none" data-background="img/soAllIHaveToDo3.png" data-background-size="contain">
					</section>
					<section data-transition="none" data-background-transition="none" data-background="img/soAllIHaveToDo4.png" data-background-size="contain">
					</section>
					<section data-transition="none" data-background-transition="none" data-background="img/soAllIHaveToDo5.png" data-background-size="contain">
					</section>
					<section data-transition="none" data-background-transition="none" data-background="img/soAllIHaveToDo6.png" data-background-size="contain">
					</section>

					<section>
						<h2>Module service pattern</h2>
						<p class="fragment">Encapsulates logic in custom service</p>
						<p class="fragment">Embeds cache service</p>
					</section>

					<section>
						<h2>Creating services</h2>
						<pre class="fragment"><code>$ drush generate service:custom</code></pre>
						<p class="fragment">Prompts you for names, dependencies, module</p>
					</section>

					<section>
						<pre><code>class MyService {

  protected $cache;

  public function __construct(CacheBackendInterface $cache) {
    $this->cache = $cache;
  }

	public function doSomething() {
		$cache_key = __METHOD__;
    $out = $this->cache->get(__METHOD__);

    if ($out === FALSE) {
				// Make some data here...
				// ...then cache.
        $this->cache->set(__METHOD__, $out);
      }
    }

    return $out;
	}
}</code></pre>
						<small class="fragment">(Scroll down.)</small>
					</section>

					<section>
						<h2>Combine as needed!</h2>
						<p class="fragment"></p>
					</section>

				</section>

				<section>
					<h2>Anti-caching recipies</h2>
					<!--
					This is intentionally at the rear because we want people know what to do first, before we break rules!
					-->
					<p class="fragment">Some text</p>
				</section>

				<section>
					<h2>Thank you!</h2>
					<!--
					Normal thank you slide with links on it
					-->
					<p class="fragment">Some text</p>
				</section>
			</div>
		</div>

		<script src="dist/reveal.js"></script>
		<script src="plugin/notes/notes.js"></script>
		<script src="plugin/markdown/markdown.js"></script>
		<script src="plugin/highlight/highlight.js"></script>
		<script>
			// More info about initialization & config:
			// - https://revealjs.com/initialization/
			// - https://revealjs.com/config/
			Reveal.initialize({
				hash: true,
				history: true,
				controls: false,
				progress: true,
				center: true,
				width: 1024,
				height: 763,
				transition: 'slide',
				plugins: [ RevealMarkdown, RevealHighlight, RevealNotes ]
			});
		</script>
	</body>
</html>
