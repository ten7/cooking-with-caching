<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<title>reveal.js</title>

		<link rel="stylesheet" href="dist/reset.css">
		<link rel="stylesheet" href="dist/reveal.css">
		<link rel="stylesheet" href="lib/css/sous-vide.css">

		<!-- Theme used for syntax highlighted code -->
		<link rel="stylesheet" href="plugin/highlight/monokai.css">
	</head>
	<body>
		<div class="reveal">
			<div class="slides">
				<section data-background-transition="none" data-background="img/PXL_20230713_163656163.jpg" data-background-size="cover"  class="section-header">
					<h1>Cooking with Caching</h1>
					<p>&nbsp;</p>
					<p>Drupal code served fast!</p>
					<small><br/>use &larr;&uarr;&darr;&rarr; or &lt;space&gt;</small>
				</section>

				<section>
					<h2>"Where's the links?"</h2>
					<p class="fragment"><a href="https://ten7.github.io/cooking-with-caching">ten7.github.io/cooking-with-caching</a></p>
				</section>

				<section>
					<section data-transition="none" data-background-transition="none" data-background="img/socketwench1.png" data-background-size="contain">
						&nbsp;
					</section>
					<section data-transition="none" data-background-transition="none" data-background="img/socketwench2.png" data-background-size="contain">
						&nbsp;
					</section>
					<section data-transition="none" data-background-transition="none" data-background="img/socketwench3.png" data-background-size="contain">
						&nbsp;
					</section>
					<section data-transition="none" data-background-transition="none" data-background="img/socketwench4.png" data-background-size="contain">
						&nbsp;
					</section>
					<section data-transition="none" data-background-transition="none" data-background="img/socketwench5.png" data-background-size="contain">
						&nbsp;
					</section>
					<section data-background-color="#5f2fe1" data-background="img/ten7-heart.png" data-background-size="cover" class="teamten7">
						<img src="src/TEN7-logo.svg" width="300" />
						<p class="fragment">Make Things That Matter</p>
						<p class="fragment">100% Remote</p>
						<p class="fragment">HQ in Minneapolis</p>
					</section>
					<section data-background-color="#5f2fe1" data-background="img/ten7-heart.png" data-background-size="cover" class="teamten7">
						<h2 class="ten7">Services</h2>
						<p class="fragment">Research & Strategy</p>
						<p class="fragment">User Experience & Design</p>
						<p class="fragment">Drupal Development</p>
						<p class="fragment">Continuous Care & Support</p>
					</section>
					<section data-background-color="#5f2fe1" data-background="img/ten7-heart.png" data-background-size="cover" class="teamten7">
						<img src="src/TEN7-logo.svg" width="300" />
						<p><a class="ten7" href="https://ten7.com/">ten7.com</a></p>
					</section>
				</section>

				<section>
					<section data-background="img/PXL_20230731_133243709.jpg" data-background-size="cover" class="section-header">
						<h1>Prepping the kitchen</h1>
						<p class="fragment">Designing for caching</p>
					</section>

					<section data-transition="none" data-background-transition="none" data-background="img/drupalSoup1.png" data-background-size="contain">
					</section>
					<section data-transition="none" data-background-transition="none" data-background="img/drupalSoup2.png" data-background-size="contain">
					</section>
					<section data-transition="none" data-background-transition="none" data-background="img/drupalSoup3.png" data-background-size="contain">
					</section>
					<section data-transition="none" data-background-transition="none" data-background="img/drupalSoup4.png" data-background-size="contain">
					</section>

					<section data-transition="none" data-background-transition="none" data-background="img/whyDoesntThisWork1.png" data-background-size="contain">
					</section>
					<section data-transition="none" data-background-transition="none" data-background="img/whyDoesntThisWork2.png" data-background-size="contain">
					</section>
					<section data-transition="none" data-background-transition="none" data-background="img/whyDoesntThisWork3.png" data-background-size="contain">
					</section>
					<section data-transition="none" data-background-transition="none" data-background="img/whyDoesntThisWork4.png" data-background-size="contain">
					</section>

					<section>
						<h2>Easy mistakes</h2>
						<p class="fragment">Testing only logged in</p>
						<p class="fragment">Using only User #1</p>
					</section>

					<section>
						<h2>Anonymous users</h2>
						<p class="fragment">Everything is cached<em class="fragment">, everything</em></p>
						<p class="fragment">Designed to be hard to bypass</p>
					</section>

					<section data-transition="none" data-background-transition="none" data-background="img/lookingUp.png" data-background-size="contain">
						<h2>Local isn't prod!</h2>
						<p class="fragment">Background "hum" of traffic</p>
						<p class="fragment">Fewer caching layers</p>
					</section>
					<section data-transition="none" data-background-transition="none" data-background="img/causeAndSolution1.png" data-background-size="contain">
						<h2>Local isn't prod!</h2>
						<p class="">Background "hum" of traffic</p>
						<p class="">Fewer caching layers</p>
					</section>

					<section>
						<h2>First anon request</h2>
						<p class="fragment">Determines cache content...</p>
						<p class="fragment">...for <em>all</em> anon users!</p>
					</section>

					<section data-transition="none" data-background-transition="none" data-background="img/lookingUpLaptop.png" data-background-size="contain">
					</section>
					<section data-transition="none" data-background-transition="none" data-background="img/putDrushCrInCron1.png" data-background-size="contain">
					</section>
					<section data-transition="none" data-background-transition="none" data-background="img/putDrushCrInCron2.png" data-background-size="contain">
					</section>

					<section data-transition="none" data-background-transition="none" data-background="img/lookingDownLaptop.png" data-background-size="contain">
						<h2>Please dont</h2>
						<p class="fragment">Masks the real problem</p>
						<p class="">&nbsp;</p>
					</section>
					<section data-transition="none" data-background-transition="none" data-background="img/cacheClearAll2.png" data-background-size="contain">
						<h2>Please dont</h2>
						<p class="">Masks the real problem</p>
						<p class="">Clear all causes a <em>stampede</em></p>
					</section>

					<section data-transition="none" data-background-transition="none" data-background="img/longRecovery1.png" data-background-size="contain">
					</section>
					<section data-transition="none" data-background-transition="none" data-background="img/longRecovery2.png" data-background-size="contain">
					</section>
					<section data-transition="none" data-background-transition="none" data-background="img/longRecovery3.png" data-background-size="contain">
					</section>
					<section data-transition="none" data-background-transition="none" data-background="img/longRecovery4.png" data-background-size="contain">
					</section>
					<section data-transition="none" data-background-transition="none" data-background="img/longRecovery5.png" data-background-size="contain">
					</section>

					<section>
						<h2>Bypassing cache</h2>
						<p class="fragment">Opens a Denial of Service vector!</p>
						<p class="fragment">Caching is a <ins>tradeoff</ins></p>
					</section>

					<section data-transition="none" data-background-transition="none" data-background="img/pickTwo1.png" data-background-size="contain">
					</section>
					<section data-transition="none" data-background-transition="none" data-background="img/pickTwo2.png" data-background-size="contain">
					</section>
					<section data-transition="none" data-background-transition="none" data-background="img/pickTwo3.png" data-background-size="contain">
					</section>
					<section data-transition="none" data-background-transition="none" data-background="img/pickTwo4.png" data-background-size="contain">
					</section>
					<section data-transition="none" data-background-transition="none" data-background="img/pickTwo5.png" data-background-size="contain">
					</section>

					<section>
						<h2>Not caching costs</h2>
						<p class="fragment">Additional server load</p>
						<p class="fragment">Business from slow responsiveness</p>
						<p class="fragment">Potential downtime</p>
					</section>

					<section data-transition="slide" data-background="img/workWithCaching.png" data-background-size="contain">
					</section>

				</section>

<!--				<section data-transition="none" data-background-transition="none">-->
<!--					<h2>Who's this for?</h2>-->
<!--					<p>&nbsp;</p>-->
<!--					<p>&nbsp;</p>-->
<!--					<p>&nbsp;</p>-->
<!--					<p>&nbsp;</p>-->
<!--					<p>&nbsp;</p>-->
<!--					<p>&nbsp;</p>-->
<!--				</section>-->
<!--				<section data-transition="none" data-background-transition="none" data-background="img/audience1.png" data-background-size="contain">-->
<!--					<h2>Who's this for?</h2>-->
<!--					<p>&nbsp;</p>-->
<!--					<p>&nbsp;</p>-->
<!--					<p>&nbsp;</p>-->
<!--					<p>&nbsp;</p>-->
<!--					<p>&nbsp;</p>-->
<!--					<p>&nbsp;</p>-->
<!--				</section>-->
<!--				<section data-transition="none" data-background-transition="none" data-background="img/audience2.png" data-background-size="contain">-->
<!--					<h2>Who's this for?</h2>-->
<!--					<p>&nbsp;</p>-->
<!--					<p>&nbsp;</p>-->
<!--					<p>&nbsp;</p>-->
<!--					<p>&nbsp;</p>-->
<!--					<p>&nbsp;</p>-->
<!--					<p>&nbsp;</p>-->
<!--				</section>-->

<!--				<section data-background-transition="slide" data-background="img/idLikeToHelp.png" data-background-size="contain">-->
<!--				</section>-->

				<section>
					<section data-background="img/snacks.jpg" data-background-size="cover" class="section-header">
						<h1>Snacks</h1>
						<p class="fragment">Tiny morsels of caching</p>
					</section>

					<section>
						<h2>Cache within the same request</h2>
						<p class="fragment">Small speedups</p>
						<p class="fragment">Encourage use of <code>$myClass->myMethod()</code></p>
					</section>

					<section>
						<h2>Static vars</h2>
						<p class="fragment">Persist for their <em>scope</em></p>
						<p class="fragment">Method, Function</p>
						<p class="fragment">Different from static class <em>properties</em>!</p>
					</section>

					<section>
						<pre><code>
function myFunction() {
	static $myVar = NULL;

	if (empty($myVar)) {
		// Generate the value here.
	}

	return $myVar;
}
						</code></pre>
					</section>

					<section>
						<h2>Static vars with reset</h2>
						<p class="fragment">Bypass cache when appropriate</p>
						<p class="fragment">Allow regeneration <ins>within the same request</ins></p>
					</section>

					<section>
						<pre><code>
function myFunction(bool $reset = FALSE) {
	static $myVar = NULL;

	if (empty($myVar) || $reset) {
		// Generate the value here.
	}

	return $myVar;
}
						</code></pre>
					</section>
				</section>

				<section>
					<section data-background="img/ingredients.jpg" data-background-size="cover" class="section-header">
						<h1>Ingredients</h1>
						<p class="fragment">Sharing static vars</p>
					</section>

					<section>
						<h2>Why share?</h2>
						<p class="fragment">Use across methods, functions</p>
						<p class="fragment">Rarer, but useful!</p>
					</section>

					<section>
						<h2>drupal_static()</h2>
						<p class="fragment">Part of Drupal core</p>
						<p class="fragment">Assigns a globally unique name</p>
					</section>

					<section>
						<h2>When to use</h2>
						<p class="fragment">Function, method called <em>a lot</em></p>
						<p class="fragment">Value <em>never</em> needs reset mid-request!</p>
					</section>

					<section>
						<pre><code>
function myMethod() {
	$cache = &drupal_static(__FUNCTION__, FALSE);

	if (empty($cache)) {
		// Generate the value here.
	}

	return $cache;
}
						</code></pre>
					</section>

					<section>
						<h2><code>__FUNCTION__</code></h2>
						<p class="fragment">Constant, part of PHP</p>
						<p class="fragment">Replaced with the current function name</p>
					</section>
					<section>
						<h2>Why?</h2>
						<p class="fragment">Function names must be globally unique!</p>
						<p class="fragment">Easier refactoring</p>
					</section>

					<section>
						<h2>What about a class?</h2>
						<p class="fragment">Method names not globally unique</p>
						<p class="fragment"><code>__FUNCTION__</code> won't work!</p>
					</section>

					<section>
						<pre><code>
class MyClass {
	public function myMethod() {
		$cache = &drupal_static(__METHOD__, FALSE);

		if (empty($cache)) {
			// Generate the value here.
		}

		return $cache;
	}
}
						</code></pre>
					</section>

					<section>
						<h2><code>__METHOD__</code></h2>
						<p class="fragment">Like <code>__FUNCTION__</code></p>
						<p class="fragment">but includes class, namespace</p>
					</section>
				</section>

				<section>
					<section data-background="img/peelingPotatoes.jpg" data-background-size="cover" class="section-header">
						<h1>Peeling Potatoes</h1>
						<p class="fragment">Flexible static caching</p>
					</section>

					<section>
						<h2>Parameterizing static vars</h2>
						<p class="fragment">Create different results</p>
						<p class="fragment">Generate on ask</p>
					</section>

					<section>
						<pre><code>
class MyClass {
	public function myMethod(string $myParam) {

		// Init the cache to an array, not just FALSE.
		$cache = &drupal_static(__METHOD__, []);

		if (empty($cache[$param])) {
			// Generate the value for $myParam here.
		}

		return $cache[$param];
	}
}
						</code></pre>
					</section>

					<section>
						<h2>Use an array</h2>
						<p class="fragment">The parameter is the <code>$key</code></p>
						<p class="fragment">Generate only for the given value</p>
					</section>

					<section>
						<h2>Only useful for scalars!</h2>
						<p class="fragment">Mostly <code>string</code> and <code>int</code></p>
						<p class="fragment">Rarely <code>bool</code> and <code>float</code></p>
					</section>

					<section>
						<h2>Reference parameters</h2>
						<p class="fragment">Objects, arrays</p>
						<p class="fragment">Generate a unique cache key</p>
					</section>

					<section>
						<pre><code>
class MyClass {
	public function myMethod(NodeInterface $node) {
		// Get the node ID, it's unique enough here.
		$nid = $node->id();

		$cache = &drupal_static(__METHOD__, []);

		if (empty($cache[$nid])) {
			// Generate the value for the node with ID $nid.
		}

		return $cache[$nid];
	}
}
						</code></pre>
					</section>

					<section>
						<h2>Multiple parameters</h2>
						<p class="fragment">Same idea!</p>
						<p class="fragment">with a longer key and hashing</p>
					</section>

					<section>
						<pre><code>
class MyClass {
	public function myMethod(NodeInterface $node,
							             string $param1,
							             string $param2) {

		// Get unique value for each, make a string, hash it.
		$cid = md5(implode(':', [$node->id(), $param1, $param2]));

		$cache = &drupal_static(__METHOD__, []);

		if (empty($cache[$cid])) {
			// Generate the value the unique $cid.
		}

		return $cache[$cid];
	}
}
						</code></pre>
						<small class="fragment">(Scroll down.)</small>
					</section>

					<section>
						<h2>Takeaways</h2>
						<p class="fragment">Use <code>drupal_static()</code> more often</p>
						<p class="fragment">Easy, low risk</p>
					</section>
				</section>

				<section>
					<section data-background="img/breakfast.jpg" data-background-size="cover" class="section-header">
						<h1>Breakfast</h1>
						<p class="fragment">Essential part of your site!</p>
					</section>

					<section>
						<h2>Front-side caching</h2>
						<p class="fragment">Caches generated HTML</p>
						<p class="fragment">Infrastructure <em>outside</em> of Drupal!</p>
					</section>

					<section>
						<h2>Varnish</h2>
						<p class="fragment">Acts as a reverse proxy</p>
						<p class="fragment">Free, Open Source</p>
					</section>

					<section>
						<h2>Using Varnish</h2>
						<p class="fragment">Requires VCL to configure</p>
						<p class="fragment">Self-hosted, needs a VPS!</p>
						<small class="fragment"><a href="https://www.varnish-software.com/developers/tutorials/configuring-varnish-drupal/">varnish-software.com/developers/tutorials/configuring-varnish-drupal</a></small>
					</section>

					<section data-transition="none" data-background-transition="none" data-background="img/lookingDownLaptop.png" data-background-size="contain">
					</section>
					<section data-transition="none" data-background-transition="none" data-background="img/looksComplicated1.png" data-background-size="contain">
					</section>
					<section data-transition="none" data-background-transition="none" data-background="img/looksComplicated2.png" data-background-size="contain">
					</section>

					<section>
						<h2>CDNs</h2>
						<p class="fragment">Same idea as Varnish...</p>
						<p class="fragment">...but as a geo-aware service!</p>
					</section>

					<section>
						<h2>Value-adds</h2>
						<p class="fragment">DDoS, Bot protection</p>
						<p class="fragment">Can save on hosting costs</p>
					</section>

					<section>
						<h2>CDN providers</h2>
						<p class="fragment">Bunny.net, Fastly, KeyCDN, others</p>
						<p class="fragment">Typically take over as your site's DNS</p>
					</section>

					<section data-transition="none" data-background-transition="none" data-background="img/lookingUpLaptop.png" data-background-size="contain">
						<h2>Purge module</h2>
						<p class="fragment">Not necessary, but helps!</p>
						<p class="fragment">Push fine-grained invalidations to CDN</p>
						<small class="fragment"><a href="https://www.drupal.org/project/purge">drupal.org/project/purge</a></small>
					</section>
					<section data-transition="none" data-background-transition="none" data-background="img/purgeModule1.png" data-background-size="contain">
						<h2>Purge module</h2>
						<p class="">Not necessary, but helps!</p>
						<p class="">Push fine-grained invalidations to CDN</p>
						<small class=""><a href="https://www.drupal.org/project/purge">drupal.org/project/purge</a></small>
					</section>
				</section>

				<section>
					<section data-background="img/secondBreakfast.jpg" data-background-size="cover" class="section-header">
						<h1>Second Breakfast</h1>
						<p class="fragment">Beyond the request</p>
					</section>

<!--					<section data-background="img/brunch.png" data-background-size="contain">-->
<!--					</section>-->

					<section data-transition="none" data-background-transition="none" data-background="img/whatAboutRedis1.png" data-background-size="contain">
						<h2>Persistent caching</h2>
						<p class="fragment">Cache values to <em>persistent store</em></p>
						<p class="fragment">Typically, to the database</p>
					</section>
					<section data-transition="none" data-background-transition="none" data-background="img/whatAboutRedis2.png" data-background-size="contain">
						<h2>Persistent caching</h2>
						<p class="">Cache values to <em>persistent store</em></p>
						<p class="">Typically, to the database</p>
					</section>
					<section data-transition="none" data-background-transition="none" data-background="img/whatAboutRedis3.png" data-background-size="contain">
						<h2>Persistent caching</h2>
						<p class="">Cache values to <em>persistent store</em></p>
						<p class="">Typically, to the database</p>
					</section>

					<section data-transition="none" data-background-transition="none" data-background="img/whatAboutRedis4.png" data-background-size="contain">
						<h2>You don't!</h2>
						<p class="fragment">Redis, Memcache modules provide drivers</p>
					</section>
					<section data-transition="none" data-background-transition="none" data-background="img/whatAboutRedis5.png" data-background-size="contain">
						<h2>You don't!</h2>
						<p class="">Redis, Memcache modules provide drivers</p>
					</section>

					<section>
						<h2>Cache API</h2>
						<p class="fragment"><code>Drupal::cache()</code></p>
					</section>

					<section>
						<pre><code>
// Get the cache backend.
$cache = \Drupal::cache();

// Save something to it.
$cache->set('my:cache:key', $myValue);

// Get something from it.
$value = $cache->get('a:different:key');
						</code></pre>
					</section>

					<section data-background="img/bins.png" data-background-size="contain">
						<h2>Bins</h2>
						<p class="fragment">Divides up caches</p>
						<p class="fragment">Helps avoid "key stomping"</p>
					</section>

					<section>
						<pre><code>
$cacheBin = \Drupal::cache('default');

// Different bin...
$cacheBin->set('my:cache:key', $myValue);

// ...same set() and get().
$value = $cacheBin->get('a:different:key');
						</code></pre>
					</section>

					<section>
						<h2>Common cache bins</h2>
						<ul>
							<li class="fragment"><code>default</code>, regularly accessed data</li>
							<li class="fragment"><code>data</code>, better when less accessed</li>
							<li class="fragment"><code>bootstrap</code>, <code>render</code>, <code>discovery</code>, used internally</li>
						</ul>
					</section>

					<section>
						<h2>Where's it end up?</h2>
						<p class="fragment">Typically, a bin-named database table</p>
						<p class="fragment">Different bins, different drivers</p>
					</section>

					<section data-transition="none" data-background-transition="none" data-background="img/butIWantMyOwn1.png" data-background-size="contain">
					</section>

					<section data-transition="none" data-background-transition="none" data-background="img/butIWantMyOwn2.png" data-background-size="contain">
					</section>
				</section>

				<section>
					<section data-background="img/pizza.jpg" data-background-size="cover" class="section-header">
						<h1>Lunch</h1>
						<p class="fragment">Custom cache bins</p>
					</section>

					<section data-background="img/aBinOfHerOwn.png" data-background-size="contain">
						<h2>Defined as a service</h2>
						<p class="fragment">No need to boilerplate a class!</p>
						<p class="fragment">Just create some YAML!</p>
					</section>

					<section data-transition="none">
						<pre><code>
docroot/modules/custom/my_module
├── config/
├── my_module.info.yml
├── my_module.module
│
└── src/
						</code></pre>
					</section>

					<section data-transition="none">
						<pre><code>
docroot/modules/custom/my_module
├── config/
├── my_module.info.yml
├── my_module.module
├── my_module.services.yml  // add or edit this file
└── src/
						</code></pre>
					</section>

					<section>
						<pre><code>
services:
  cache.my_module:
    class: Drupal\Core\Cache\CacheBackendInterface
    tags:
      - { name: cache.bin }
    factory: ['@cache_factory', 'get']
    arguments: [my_module]
						</code></pre>
					</section>

					<section>
						<h2>Using custom bins</h2>
						<pre class="fragment"><code>
$my_module_cache = \Drupal::cache('my_module');
						</code></pre>
						<p class="fragment">...or...</p>
						<pre class="fragment"><code>
$my_module_cache = \Drupal::service('cache.my_module');
						</code></pre>
					</section>

					<section>
						<h2>Cache injection</h2>
						<p class="fragment">Use on forms, plugins, controllers</p>
					</section>

					<section>
						<pre><code>class MyController extends ControllerBase {

	public static function create(ContainerInterface $container) {
    $myCache = $container->get('cache.my_module');

    return new static($myCache);
  }

	public __construct(CacheBackendInterface $cache) {
		$this->cache = $cache;
	}

	public doSomething() {
		$this->cache->get('my:cache:key');
	}
}</code></pre>
					</section>

					<section data-transition="none" data-background-transition="none" data-background="img/soAllIHaveToDo1.png" data-background-size="contain">
					</section>
					<section data-transition="none" data-background-transition="none" data-background="img/soAllIHaveToDo2.png" data-background-size="contain">
					</section>
					<section data-transition="none" data-background-transition="none" data-background="img/soAllIHaveToDo3.png" data-background-size="contain">
					</section>
					<section data-transition="none" data-background-transition="none" data-background="img/soAllIHaveToDo4.png" data-background-size="contain">
					</section>
					<section data-transition="none" data-background-transition="none" data-background="img/soAllIHaveToDo5.png" data-background-size="contain">
					</section>
					<section data-transition="none" data-background-transition="none" data-background="img/soAllIHaveToDo6.png" data-background-size="contain">
					</section>

					<section>
						<h2>Module service pattern</h2>
						<p class="fragment">Encapsulates logic in custom service</p>
						<p class="fragment">Embeds cache service</p>
					</section>

					<section data-transition="none" data-background-transition="none" data-background="img/lookingUpLaptop.png" data-background-size="contain">
						<h2>Creating services</h2>
						<pre class="fragment"><code>$ drush generate service:custom</code></pre>
						<p class="fragment">Prompts you for names, dependencies, module</p>
					</section>
					<section data-transition="none" data-background-transition="none" data-background="img/moduleService.png" data-background-size="contain">
						<h2>Creating services</h2>
						<pre class=""><code>$ drush generate service:custom</code></pre>
						<p class="">Prompts you for names, dependencies, module</p>
					</section>

					<section>
						<pre><code>
docroot/modules/custom/my_module
├── config/
├── my_module.info.yml
├── my_module.module
├── my_module.services.yml  // Update this...
└── src/
		└── MyService.php	 // ...and this too.
						</code></pre>
					</section>

					<section>
						<pre><code>services:
  cache.my_module:
    class: Drupal\Core\Cache\CacheBackendInterface
    tags:
      - { name: cache.bin }
    factory: ['@cache_factory', 'get']
    arguments: [my_module]

	my_module:
		class: Drupal\my_module\MyService
		arguments: ['@cache.my_module']
</code></pre>
					</section>

					<section>
						<pre><code>class MyService {

  protected $cache;

  public function __construct(CacheBackendInterface $cache) {
    $this->cache = $cache;
  }

	public function doSomething() {
		$out = $this->cache->get(__METHOD__);

    if ($out === FALSE) {
				// Make some data here...
				// ...then cache.
        $this->cache->set(__METHOD__, $out);
      }
    }

    return $out;
	}
}</code></pre>
						<small class="fragment">(Scroll down.)</small>
					</section>

					<section>
						<h2>Combine as needed!</h2>
						<p class="fragment">Cache service, <code>drupal_static()</code></p>
						<p class="fragment">No param, reference param, multiple params!</p>
					</section>
					<section>
						<h2>Tidy & Transparent</h2>
						<p class="fragment">Module service centralizes code changes</p>
					</section>

				</section>

				<!--
				Tea: View Caching
				-->

				<section>
					<section data-background="img/kitchen.jpg" data-background-size="cover" class="section-header">
						<h1>Dinner</h1>
						<p class="fragment">Manipulating cache</p>
					</section>

					<section  data-transition="none" data-background-transition="none" data-background="img/lookingDownLaptop.png" data-background-size="contain">
						<h2>Cache Invalidation</h2>
						<p class="fragment">Cached data can get stale</p>
						<p class="fragment">By name, time, or grouping</p>
					</section>
					<section data-transition="none" data-background-transition="none" data-background="img/cacheClearAll4.png" data-background-size="contain">
						<h2>Cache Invalidation</h2>
						<p class="">Cached data can get stale</p>
						<p class="">By name, time, or grouping</p>
					</section>
					<section data-transition="none" data-background-transition="none" data-background="img/cacheClearAll5.png" data-background-size="contain">
						<h2>Cache Invalidation</h2>
						<p class="">Cached data can get stale</p>
						<p class="">By name, time, or grouping</p>
					</section>

					<section data-transition="none" data-background-transition="none" data-background="img/binDeleteAll1.png" data-background-size="contain">
						<pre><code>$cacheBin = \Drupal::cache('my_module');

// Delete a key...
$cacheBin->delete('my:cache:key');

// ...multiple keys...
$cacheBin->deleteMultiple(['my:cache:key', 'another:key']);

// ...or the whole bin.
$value = $cacheBin->deleteAll();</code></pre>
					</section>
					<section data-transition="none" data-background-transition="none" data-background="img/binDeleteAll2.png" data-background-size="contain">
						<pre><code>$cacheBin = \Drupal::cache('my_module');

// Delete a key...
$cacheBin->delete('my:cache:key');

// ...multiple keys...
$cacheBin->deleteMultiple(['my:cache:key', 'another:key']);

// ...or the whole bin.
$value = $cacheBin->deleteAll();</code></pre>
					</section>

					<section>
						<h2>TTLs</h2>
						<p class="fragment"><em>Time to live</em></p>
						<p class="fragment">Seconds remaining before expiry</p>
					</section>

					<section>
						<pre><code>
$cacheBin = \Drupal::cache('my_module');

// Generate a TTL in seconds.
$ttl = strtotime('+6 hours');

// Set the key.
$cacheBin->set('my:cache:key', $myValue, $ttl);
						</code></pre>
					</section>

					<section data-transition="none" data-background-transition="none" data-background="img/untilAClearAllAtLeast1.png" data-background-size="contain">
						<h2>Default TTL</h2>
						<pre class="fragment"><code>Drupal\Core\Cache\Cache::PERMANENT</code></pre>
					</section>
					<section data-transition="none" data-background-transition="none" data-background="img/untilAClearAllAtLeast2.png" data-background-size="contain">
						<h2>Default TTL</h2>
						<pre class=""><code>Drupal\Core\Cache\Cache::PERMANENT</code></pre>
					</section>

					<section>
						<h2>How long to live?</h2>
						<p class="fragment">Shorter is prefered by editors</p>
						<p class="fragment">Longer is preferred by operations</p>
					</section>

					<section data-transition="slide" data-background-transition="none" data-background="img/pickTwo5.png" data-background-size="contain">
					</section>

					<section>
						<h2>Make it configurable</h2>
						<p class="fragment">Be mindful of min and max TTLs!</p>
						<p class="fragment">Default to a happy medium</p>
					</section>

					<section>
						<h2>Module settings form</h2>
						<pre class="fragment"><code>drush generate module</code></pre>
						<p class="fragment">Admin &gt; Config &gt; System &gt; My Module</p>
					</section>

					<section>
						<h2>Module service Pattern</h2>
						<p class="fragment">Loads the module config</p>
						<p class="fragment">Keeps Cache TTLs transparent</p>
					</section>

					<section>
						<pre><code>services:
  cache.my_module:
    class: Drupal\Core\Cache\CacheBackendInterface
    tags:
      - { name: cache.bin }
    factory: ['@cache_factory', 'get']
    arguments: [my_module]

	my_module:
		class: Drupal\my_module\MyService
		arguments: ['@cache.my_module', '@config.factory']
                                    # Added the config factory
</code></pre>
					</section>

					<section>
						<pre><code>class MyService {

  protected $cache;
  protected $config;

  public function __construct(CacheBackendInterface $cache,
							                ConfigFactory $configFactory) {
    $this->cache = $cache;
		$this->config = $configFactory->get('my_module');
  }

	public function getTtl() {
		$ttl = &drupal_static(__METHOD__, NULL);

		if (empty($ttl)) {
			$ttl = $this->config->get('ttl');
		}

		return intval($ttl) ?? 3600;
	}

	public function doSomething() {
		$out = $this->cache->get(__METHOD__);

    if ($out === FALSE) {
				// Make some data here...
				// ...then cache.
        $this->cache->set(__METHOD__, $out, $this->getTtl());
      }
    }

    return $out;
	}
}</code></pre>
						<small class="fragment">(Scroll down.)</small>
					</section>

					<section>
						<h2>Cache Tags</h2>
						<p class="fragment">Allows bin to be divided up</p>
						<p class="fragment">Enables cross-bin invalidation</p>
					</section>

					<section>
						<h2>Tag names</h2>
						<p class="fragment">Anything, as long as it's unique!</p>
					</section>

					<section>
						<h2>Common tag names</h2>
						<pre class="fragment"><code>my_module:a:unique:key</code></pre>
						<pre class="fragment"><code>entity_type:entity_id</code></pre>
						<pre class="fragment"><code>config:config_name</code></pre>
					</section>

					<section>
						<h2>You define the tags</h2>
						<p class="fragment">...not the user!</p>
						<p class="fragment">Avoid configurability here</p>
					</section>

					<section>
						<pre><code>
$cacheBin = \Drupal::cache('my_module');

// Make some data here...
// ...set the tags...
$tags = [$entity->getEntityTypeId() . ':' . $entity->id()];

// ...then cache.
$cacheBin->set('my:cache:key', $myValue, Cache::PERMANENT, $tags);
						</code></pre>
					</section>

					<section>
						<h2>Invalidating tags</h2>
						<p class="fragment">Not part of <code>\Drupal::cache()</code>!</p>
						<p class="fragment"><code>cache_tags.invalidator</code> service</p>
					</section>

					<section data-transition="none" data-background-transition="none" data-background="img/nodeInvalidate1.png" data-background-size="contain">
						<pre><code>
$invalidator = \Drupal::service('cache_tags.invalidator');
$invalidator->invalidateTags(['node:5']);
						</code></pre>
					</section>
					<section data-transition="none" data-background-transition="none" data-background="img/nodeInvalidate2.png" data-background-size="contain">
						<pre><code>
$invalidator = \Drupal::service('cache_tags.invalidator');
$invalidator->invalidateTags(['node:5']);
						</code></pre>
					</section>
					<section data-transition="none" data-background-transition="none" data-background="img/nodeInvalidate3.png" data-background-size="contain">
						<pre><code>
$invalidator = \Drupal::service('cache_tags.invalidator');
$invalidator->invalidateTags(['node:5']);
						</code></pre>
					</section>

					<section  data-transition="none" data-background-transition="none" data-background="img/nodeInvalidate1.png" data-background-size="contain">
						<h2>Yes!</h2>
						<pre class="fragment"><code>// Get the nodes and tags
$node = Node::load(5);
$node_cache_tags = $node->getCacheTagsToInvalidate()

// Invalidate them all!
$invalidator = \Drupal::service('cache_tags.invalidator');
$invalidator->invalidateTags($node_cache_tags);</code></pre>
					</section>
					<section  data-transition="none" data-background-transition="none" data-background="img/nodeInvalidate4.png" data-background-size="contain">
						<h2>Yes!</h2>
						<pre><code>// Get the nodes and tags
$node = Node::load(5);
$node_cache_tags = $node->getCacheTagsToInvalidate()

// Invalidate them all!
$invalidator = \Drupal::service('cache_tags.invalidator');
$invalidator->invalidateTags($node_cache_tags);</code></pre>
					</section>
				</section>

				<section>
					<section data-background="img/chopping.jpg" data-background-size="cover" class="section-header">
						<h1>Chopping</h1>
						<p class="fragment">Render caching</p>
					</section>

					<section data-transition="none" data-background-transition="none" data-background="img/onion1.png" data-background-size="contain">
					</section>
					<section data-transition="none" data-background-transition="none" data-background="img/onion2.png" data-background-size="contain">
					</section>
					<section data-transition="none" data-background-transition="none" data-background="img/onion3.png" data-background-size="contain">
					</section>
					<section data-transition="none" data-background-transition="none" data-background="img/onion4.png" data-background-size="contain">
					</section>
					<section data-transition="none" data-background-transition="none" data-background="img/onion5.png" data-background-size="contain">
					</section>
					<section data-transition="none" data-background-transition="none" data-background="img/onion6.png" data-background-size="contain">
					</section>
					<section data-transition="none" data-background-transition="none" data-background="img/onion7.png" data-background-size="contain">
					</section>

					<section>
						<h2>Controlling Caching</h2>
						<p class="fragment">Set for any render array</p>
						<p class="fragment"><code>#cache</code> key</p>
					</section>

					<section data-transition="none" data-background-transition="none" data-background="img/lookingUpLaptop.png" data-background-size="contain">
						<pre><code>$out = [
	'#theme' => 'my_theme',
	'#cache' => [
		'max-age' => $this->myService->getTtl(),
		'tags' => [
			$entity->getEntityTypeId() . ':' . $entity->id(),
		],
		'contexts' => [],
	],
];</code></pre>
					</section>
					<section data-transition="none" data-background-transition="none" data-background="img/thatLooksFamiliar1.png" data-background-size="contain">
						<pre><code>$out = [
	'#theme' => 'my_theme',
	'#cache' => [
		'max-age' => $this->myService->getTtl(),
		'tags' => [
			$entity->getEntityTypeId() . ':' . $entity->id(),
		],
		'contexts' => [],
	],
];</code></pre>
					</section>

					<section data-transition="none" data-background-transition="none" data-background="img/lookingUpLaptop.png" data-background-size="contain">
						<h2 class="">Same ideas</h2>
						<p class="fragment"><code>max-age</code> is a TTL</p>
						<p class="fragment"><code>tags</code> are cache tags</p>
					</section>
					<section data-transition="none" data-background-transition="none" data-background="img/thatLooksFamiliar2.png" data-background-size="contain">
						<h2 class="">Same ideas</h2>
						<p class=""><code>max-age</code> is a TTL</p>
						<p class=""><code>tags</code> are cache tags</p>
					</section>

					<section>
						<h2>Cache contexts</h2>
						<p class="fragment">Cache by aspect of request</p>
						<p class="fragment">User, Language, URL, etc.</p>
						<small class="fragment">drupal.org/docs/drupal-apis/cache-api/cache-contexts</small>
					</section>

					<section>
						<pre><code>
$out = [
	'#theme' => 'my_theme',
	'#cache' => [
		'max-age' => $this->myService->getTtl(),
		'tags' => [
			$entity->getEntityTypeId() . ':' . $entity->id(),
		],
		'contexts' => [
			'url.query_args:my_query_arg',  // Specify contexts
		],
	],
];
						</code></pre>
					</section>

<!--					<section>-->
<!--						<h2>Context varients</h2>-->
<!--						<p class="fragment">Vary by a <em>part</em> of the context</p>-->
<!--						<p class="fragment"><code>contextName.varientName</code></p>-->
<!--					</section>-->

<!--					<section>-->
<!--						<h2>Varient parts</h2>-->
<!--						<p class="fragment">Select part of a varient</p>-->
<!--						<p class="fragment"><code>contextName.varientName:partName</code></p>-->
<!--					</section>-->

					<section data-transition="none" data-background-transition="none" data-background="img/cacheContexts1.png" data-background-size="contain">
						<h2>URL contexts</h2>
						<ul>
							<li class="fragment"><code>url</code>: The entire URL</li>
							<li class="fragment"><code>url.query_args</code>: Vary by query args only</li>
							<li class="fragment"><code>url.query_args:argName</code>: Vary only by given arg</li>
						</ul>
					</section>
					<section data-transition="none" data-background-transition="none" data-background="img/cacheContexts2.png" data-background-size="contain">
						<h2>URL contexts</h2>
						<ul>
							<li class=""><code>url</code>: The entire URL</li>
							<li class=""><code>url.query_args</code>: Vary by query args only</li>
							<li class=""><code>url.query_args:argName</code>: Vary only by given arg</li>
						</ul>
					</section>
					<section data-transition="none" data-background-transition="none" data-background="img/cacheContexts3.png" data-background-size="contain">
						<h2>URL contexts</h2>
						<ul>
							<li class=""><code>url</code>: The entire URL</li>
							<li class=""><code>url.query_args</code>: Vary by query args only</li>
							<li class=""><code>url.query_args:argName</code>: Vary only by given arg</li>
						</ul>
					</section>
				</section>

				<section>
					<section data-background="img/dessert.jpg" data-background-size="cover" class="section-header">
						<h1>Dessert</h1>
						<p>Anti-caching recipes</p>
					</section>

<!--					<section data-transition="none" data-background-transition="none" data-background="img/riskyStuff1.png" data-background-size="contain">-->
<!--					</section>-->
<!--					<section data-transition="none" data-background-transition="none" data-background="img/riskyStuff2.png" data-background-size="contain">-->
<!--					</section>-->
<!--					<section data-transition="none" data-background-transition="none" data-background="img/riskyStuff3.png" data-background-size="contain">-->
<!--					</section>-->

					<section data-transition="none" data-background-transition="none" data-background="img/lookingUpLaptop.png" data-background-size="contain">
						<h2>Lazy Builders</h2>
						<p class="fragment">Puts a <em>placeholder</em> in the output</p>
						<p class="fragment">Replaced at a later stage of rendering</p>
					</section>
					<section data-transition="none" data-background-transition="none" data-background="img/aLaterStage1.png" data-background-size="contain">
						<h2>Lazy Builders</h2>
						<p class="">Puts a <em>placeholder</em> in the output</p>
						<p class="">Replaced at a later stage of rendering</p>
					</section>
					<section data-transition="none" data-background-transition="none" data-background="img/aLaterStage2.png" data-background-size="contain">
						<h2>Lazy Builders</h2>
						<p class="">Puts a <em>placeholder</em> in the output</p>
						<p class="">Replaced at a later stage of rendering</p>
					</section>

					<section>
						<pre><code>class MyController extends ControllerBase {
	public function build() {
		$out = [
			'#markup' => 'Normally, you'd put your content here.',
			'#cache' => [...],
		];

		return $out;
	}
}</code></pre>
					</section>

					<section>
						<pre><code>class MyController extends ControllerBase {
	public function build() {
		$out = [
			'#lazy_builder' => static::class . '::lazyBuilder',
			'#cache' => [...],
		];

		return $out;
	}

	public static function lazyBuilder() {
			return ['#markup' => 'Lazy built stuff here!'];
	}
}</code></pre>
					</section>

					<section data-transition="none" data-background-transition="none" data-background="img/lookingDownLaptop.png" data-background-size="contain">
					</section>
					<section data-transition="none" data-background-transition="none" data-background="img/trustedCallback1.png" data-background-size="contain">
					</section>

					<section>
						<h2>Trusted Callbacks</h2>
						<p class="fragment">A code-injection mitgation</p>
						<p class="fragment">Since Drupal 8.8</p>
						<small class="fragment"><a href="https://www.drupal.org/node/2966725">drupal.org/node/2966725</a></small>
					</section>

					<section>
						<pre><code>class MyController extends ControllerBase
							     implements TrustedCallbackInterface {
	public function build() {
		$out = [
			'#lazy_builder' => [static::class . '::lazyBuilder'],
			'#cache' => [...],
		];

		return $out;
	}

	public static function lazyBuilder() {
			return ['#markup' => 'Lazy built stuff here!'];
	}

	public static function trustedCallbacks() {
    return ['lazyBuilder'];
  }
}</code></pre>
						<small class="fragment">(Scroll down)</small>
					</section>

					<section>
						<h2>Callback methods</h2>
						<p class="fragment">Any <code>callable</code></p>
						<p class="fragment">Static method or fully qualified string</p>
					</section>

					<section data-transition="none" data-background-transition="none" data-background="img/lookingDownLaptop.png" data-background-size="contain">
					</section>
					<section data-transition="none" data-background-transition="none" data-background="img/staticOnly1.png" data-background-size="contain">
					</section>
					<section data-transition="none" data-background-transition="none" data-background="img/staticOnly2.png" data-background-size="contain">
					</section>

					<section data-transition="none" data-background-transition="none" data-background="img/lookingUpLaptop.png" data-background-size="contain">
						<h2>Service Pattern</h2>
						<pre class="fragment"><code>'#lazy_builder' => ['my_module:lazyBuilder'],</code></pre>
					</section>
					<section data-transition="none" data-background-transition="none" data-background="img/notStatic1.png" data-background-size="contain">
						<h2>Service Pattern</h2>
						<pre class=""><code>'#lazy_builder' => ['my_module:lazyBuilder'],</code></pre>
					</section>
					<section data-transition="none" data-background-transition="none" data-background="img/notStatic2.png" data-background-size="contain">
						<h2>Service Pattern</h2>
						<pre class=""><code>'#lazy_builder' => ['my_module:lazyBuilder'],</code></pre>
					</section>

					<section>
						<pre><code>class MyService implements TrustedCallbackInterface {

  protected $cache;

  public function __construct(CacheBackendInterface $cache) {
    $this->cache = $cache;
  }

	public static function trustedCallbacks() {
    return ['render'];
  }

	public function doSomething() {...}

  public function render() {
		return ['#markup' => 'Lazy built stuff here!'];
	}
}</code></pre>
						<small class="fragment">(Scroll down.)</small>
					</section>

<!--					<section data-transition="none" data-background-transition="none" data-background="img/lookingUpLaptop.png" data-background-size="contain">-->
<!--						<h2>Render Service Pattern</h2>-->
<!--						<p class="fragment">2nd service for rendering only!</p>-->
<!--						<p class="fragment">Inject your module service</p>-->
<!--					</section>-->
<!--					<section data-transition="none" data-background-transition="none" data-background="img/serviceResponsibilities1.png" data-background-size="contain">-->
<!--						<h2>Render Service Pattern</h2>-->
<!--						<p class="">2nd service for rendering only!</p>-->
<!--						<p class="">Inject your module service</p>-->
<!--					</section>-->

					<section data-transition="none" data-background-transition="none" data-background="img/lookingUpLaptop.png" data-background-size="contain">
						<h2>Passing Parameters</h2>
						<pre class="fragment"><code>'#lazy_builder' => ['my_module:lazyBuilder', $arg1, $arg2],</code></pre>
						<p class="fragment">Scalars only!</p>
					</section>

					<section data-transition="none" data-background-transition="none" data-background="img/idsNotClasses1.png" data-background-size="contain">
						<h2>Passing Parameters</h2>
						<pre class=""><code>'#lazy_builder' => ['my_module:lazyBuilder', $arg1, $arg2],</code></pre>
						<p class="">Scalars only!</p>
					</section>

					<section>
						<pre><code>class MyController extends ControllerBase {
	public function build() {
		return [
			'#lazy_builder' => ['my_module:lazyBuilder', $node->id()],
			'#cache' => [
				'tags' => [
					'my_module:my_controller:build',
				] + $node->getCacheTagsToInvalidate(),
			],
		];
	}
}</code></pre>
					</section>

					<section data-transition="slide" data-background-transition="none" data-background="img/whatAboutBlocks1.png" data-background-size="contain">
					</section>

					<section>
						<h2>Block max-age</h2>
						<p class="fragment"><code>CacheableDependencyInterface::getCacheMaxAge()</code></p>
						<p class="fragment">Override in your block class</p>
					</section>

					<section>
						<pre><code>class MyBlock extends BlockBase {
	public function build() {
		return [
			'#lazy_builder' => ['my_module:lazyBuilder'],
		];
	}

  public function getCacheMaxAge() : int {
    return 0;  // Defer to lazy builder for caching.
  }
}</code></pre>
					</section>
				</section>

				<section>
					<section>
						<h2>Further reading</h2>
						<p class=""><a href="https://www.drupal.org/docs/drupal-apis/cache-api/cache-tags">Cache Tags on Drupal.org</a></p>
						<p class=""><a href="https://api.drupal.org/api/drupal/core%21lib%21Drupal%21Core%21Render%21theme.api.php/group/theme_render/8.2.x#sec_caching">Render API Overview on Drupal.org</a></p>
						<p class=""><a href="https://www.hashbangcode.com/article/drupal-9-using-lazy-builders">Lazy builders on hashbangcode</a></p>
					</section>

					<section data-background="img/specialThanks.png" data-background-size="contain">
						<h2>Special thanks</h2>
						<p class="fragment">This event!</p>
						<p class="fragment"><a href="https://ten7.com/">TEN7</a></p>
					</section>

					<section data-background="img/thankYou.png" data-background-size="contain">
						<h2>Thank you!</h2>
						<p class="fragment"><a href="https://ten7.github.io/cooking-with-caching">ten7.github.io/cooking-with-caching</a></p>
					</section>
				</section>
			</div>
		</div>

		<script src="dist/reveal.js"></script>
		<script src="plugin/notes/notes.js"></script>
		<script src="plugin/markdown/markdown.js"></script>
		<script src="plugin/highlight/highlight.js"></script>
		<script>
			// More info about initialization & config:
			// - https://revealjs.com/initialization/
			// - https://revealjs.com/config/
			Reveal.initialize({
				hash: true,
				history: true,
				controls: false,
				progress: true,
				center: true,
				width: 1024,
				height: 763,
				transition: 'slide',
				plugins: [ RevealMarkdown, RevealHighlight, RevealNotes ]
			});
		</script>
	</body>
</html>
